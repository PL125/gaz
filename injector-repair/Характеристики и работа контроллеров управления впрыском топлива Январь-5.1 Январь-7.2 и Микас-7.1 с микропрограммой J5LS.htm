<html><head>
<meta http-equiv="Content-Language" content="ru">
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<meta name="GENERATOR" content="Microsoft FrontPage 4.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<title>Характеристики и работа контроллеров управления
впрыском топлива Январь-5.1 Январь-7.2 и Микас-7.1
с микропрограммой J5LS</title>
</head>

<body>

<h3>Характеристики и работа контроллеров управления
впрыском топлива Январь-5.1 Январь-7.2 и Микас-7.1
с микропрограммой J5LS</h3>

<p>Сердцем системы впрыска является
микроконтроллер SAF80C509 производства фирмы
Infineon, с расширенной архитектурой MCS51. Он работает с тактовой частотой 16 мгц, что
обеспечивает производительность
логических операций 2.66 mips, или 375 наносекунд
на 1 инструкцию.</p>
<p>Аппаратные средства этого кристалла и
набор периферии в ЭБУ позволяют при
небольших доработках ЭБУ строить системы
управления двигателем с числом цилиндров
до 6 либо без доработок управлять
двигателями с числом цилиндров 2 или 4.&nbsp;&nbsp;</p>
<p>Встроенный сопроцессор позволяет работать с
целочисленной арифметикой и обеспечивает
следующее время выполнения математических
операций в зависимости от разрядности (включая загрузку и выгрузку
операндов): 8*8 - 1.5мкс, 8/8 - 1.5мкс, 32/16 - 6.75 мкc, 16*16
- 6 мкс , 16/16 - 6 мкс</p>
<p>15-ти канальный Аналогово-цифровой
преобразователь, разрядностью 10
эффективных бит, может в
зависимости от требуемой точности
преобразования, обеспечивать время
преобразования от 3 до 52 мкс на канал.&nbsp;Реально
большинство каналов использует разрешение 8
бит и опрашиваются за 3мкс. Однако в случае
необходимости высокой точности (канал ДАД и
каналы потенциометров электронного
дросселя) - применяется 10-ти битный режим
опроса.</p>
<p>Функции 2D table lookup работают с таблицами
размером 33 точки и 39 точек. Диапазон значений по оси X -
от 0 до 255, выборка из таблицы с учетом
линейной интерполяции производится за 15 мкс.&nbsp;Важные
2D таблицы имеют размерность 256 точек и
выборка из них производится мгновенно.</p>
<p>Функции 3D table lookup могут работать с
таблицами размера 16x16 и 32x16. Диапазон
значений X Y - от 0 до 240,&nbsp; при выборке для
получения промежуточных значений
микропрограмма также использует функцию
линейной интерполяции. Выборка из таблицы
16x16 производится за 38мкс а из таблицы 32x16 - за
47мкс.</p>
<p>Пятиуровневая аппаратная система
приоритетов выполнения задач позволяет
рационально распределять процессорное
время. Задачи с уровнем приоритета выше
текущего могут прерывать выполнение
текущей задачи. Задачи имеющие приоритет такой же
как и текущие будут выполнены после
завершения текущей.&nbsp;&nbsp;</p>
<p>Самый низкий уровень (0) имеет&nbsp; главный 20мс
цикл вычислений.&nbsp;</p>
<p>Уровень 1 имеют задачи:</p>
<p>1) Фильтрация ДМРВ или ДАД, расчет
обогащения при увеличении дросселя и
необходимой базовой топливоподачи для
текущего такта работы двигателя и открытие
соответствующей форсунки. Расчет
производится на основе требуемого состава
смеси и информации о наполнении воздухом
полученной непосредственно на этом такте
работы двигателя. Эта задача инициируется
обработчиком ДПКВ при совпадении углового
поворота диска с установленной в системе
"фазой впрыска". Периодичность вызова
задачи соответствует интервалу работы
цилиндров (180 градусов ПКВ для 2х и 4-х
цилиндрового двигателя или 120 градусов ПКВ
для 3х и 6-ти цилиндрового).</p>
<p>2) Обработка сигнала канала детонации.
Вызывается после прохода всех фазовых окон
и чтения состояния интеграторов (114
градусов после ВМТ).</p>
<p>Уровень 2 имеет задача обработки пакетной
отправки и приема байт по протоколу K-Line. (сами
пакеты создаются и обрабатываются в
главном цикле).</p>
<p>Уровень 3 имеет задача Цикла вычислений с
интервалом 1мс.&nbsp;</p>
<p>Уровень 4 имеет задача обработки сигналов
датчиков положения коленчатого вала и фазы.</p>
<h4>Подсистема времени:</h4>
<p>В составе микропроцессора имеются 3
таймера счетчика. Основной из них T2. Его
частота 16000000/96, что обеспечивает тик
таймера = 6мкс. Это значение является базовым
дискретом задержки при реализации многих
алгоритмов связанных с положением
коленчатого вала. Регистры Т2 используются модулями захвата и
сравнения для обеспечения управления
форсунками и зажиганием, а также
определения оборотов двигателя и привязки
всех событий в системе управления по углу поворота коленчатого
вала.&nbsp;</p>
<p>Таймер T0 микропроцессора используется
только в ЭБУ Январь-7.2, для аппаратного
подсчета импульсов поступающих из схемы
детектора детонации.</p>
<p>Таймер T1 микропроцессора используется для формирования
временного интервала с периодичностью 1мс.
Частота 1кгц образуется в результате
деления тактовой частоты 16000000/6/2/1333=1000. Эта
частота необходима для работы цикла 1мс.</p>
<p>Так же микропроцессор содержит
специализированные таймера:</p>
<p>Таймер сравнения CT используется для
формирования ШИМ в каналах адсорбера и
управления давлением наддува. Он запрограммирован
для получения частоты ШИМ 15.258гц, однако в
некоторых случаях эта частота может быть
изменена (например при применении
однопроводного РХХ).</p>
<p>Таймер сравнения CT1 формирует прерывания
с частотой 2кгц (0.5ms) для обеспечения отсчета
таймаута приема пакета данных по K-line. В
версиях ПО Микас-7ET с электронным дросселем
и в блоке Январь-7.2 с моментным РХХ -
используется для управления этими
устройствами (а таймаут приема пакета
считается в цикле 1мс).</p>
<p align="left">Кроме того в системе имеются 2
генератора тактовых частот для асинхронных
приемопередатчиков (USART0 и USART1), которые
настраиваются на скорость 10400 для USART0 (возможно
изменение на 38400 и 57600) для работы K-line и 19200
для USART1 для подключения Innovate LC1 по цифровому
каналу.&nbsp;&nbsp;</p>
<h4>Цикл 1мс:</h4>
<p>В цикле 1мс микропрограмма обеспечивает
работу следующих задач:</p>
<p>1) Отсчет времени для запуска главного цикла
вычислений (интервалов 20мс).</p>
<p>2) Определение потери связи по K-line и
закрытие диагностической сессии при такой
потере. Определение таймаутов связи.</p>
<p>3) Тестирование каналов зажигания с
диагностического сканера (только в режиме
прямого управления зажиганием на
остановленном двигателе).</p>
<p>4) Обеспечение движения шагового РХХ (выбор
направления и разгон) для синхронизации текущего
положения шагового РХХ (FSM) c желаемым положением
шагового&nbsp; РХХ (SSM).</p>
<p>5) Опрос канала АЦП ДМРВ или ДАД для
последующей фильтрации сигнала.</p>
<p>6) Работу многоискрового режима зажигания
при пуске двигателя (только блоки Январь-5.1
Микас-7).</p>
<p>7) ШИМ управление клапаном адсорбера (частота
15.6гц) (Только блоки Январь-7.2 - в других ЭБУ адсорбер управляется
аппаратно).</p>
<p>8) Опрос датчика скорости автомобиля, и
подсчет импульсов c датчика скорости.</p>
<p>9) Отсчет времени для СSV лога ПАК "Матрица"
c дискретом 1мс.&nbsp;</p>
<h4>Обработчик датчика положения
коленчатого вала.</h4>
<p>Обработчик ДПКВ имеет наивысший
приоритет в системе управления, он может
прервать выполнение абсолютно любого
процесса, поэтому при его реализации
используются методики экономии
процессорного времени путем распределения
всех вычислительных задач обработчика по углу поворота
КВ (номеру зуба).
Обработчик определяет работу абсолютно
всех процессов в системе управления, так или
иначе связанных с углом поворота
коленчатого вала.&nbsp;</p>
<p>Для синхронизации системы управления по
углу поворота используется
специализированный реперный диск BOSCH MOTRONIC
60-2. На диске с равным интервалом в 6 градусов
расположены 58 зубьев c номерами от 1 до 58,
зубья номер 59 и 60 отсутствуют. Диск привязан
по углу таким образом, что при установке
первого цилиндра двигателя в ВМТ&nbsp;
вершина 20-го зуба (15 зуба для систем&nbsp;с 6ю
цилиндрами) оказывается напротив
датчика положения коленчатого вала, 1-м
считается зуб после отсутствующих по ходу
вращения диска.&nbsp;&nbsp;</p>
<p>Событие обработчика ДПКВ инициируется изменением
состояния входа P1.3 микроконтроллера, при
этом производится аппаратный захват слепка таймера
счетчика T2 и копирование его состояния в
регистры CCL3 CCH3. В дальнейшем эта информация
будет использоваться при всех расчетах с
привязкой по углу, определения оборотов,
установки момента зажигания и прочих.&nbsp;&nbsp;</p>
<p>Исходя из формы задающего диска
обработчик ДПКВ может работать в 2-х режимах:</p>
<p>Поисковый - система управления производит
поиск маркерного отрезка с отсутствующими
59 и 60 зубьями, в этом режиме невозможно
формирование импульсов зажигания и впрыска.&nbsp;</p>
<p>Синхронизированный - когда системе
управления точно известен номер зуба
задающего диска, который вызвал текущее
событие обработчика, в этом режиме могут формироваться
импульсы зажигания и впрыска, четко
привязанные к номеру зуба и номеру цилиндра.&nbsp;</p>
<p>Обработчик прерывания ДПКВ имеет
несколько важных локальных переменных.</p>
<p>1) Раскладка одного оборота двигателя на 6-ти
градусные интервалы - переменная принимает
значения от 0 (1 зуб) до 59 (60 зуб) и
обеспечивает привязку событий обработчика
к номеру зуба шестерни.&nbsp;</p>
<p>2) Раскладка одного такта двигателя на 6-ти
градусные интервалы - переменная принимает
значения от 0 (1 зуб или 31 зуб) до 29 (30 зуб или 60
зуб) и обеспечивает привязку событий к 180
градусному такту двигателя. (для&nbsp;3-6 цилиндрового от 0 до 19 и 120 градусов
соответственно).&nbsp;</p>
<p>3) Номер цилиндра двигателя - переменная
принимает значения от 0 до 3 (от 0 до 5 в 6-ти
цилиндровом ПО) и&nbsp;
обеспечивает привязку событий к
конкретному цилиндру двигателя.&nbsp;</p>
<p>4) Интервал между соседними зубьями в 6мс
тиках таймера Т2 - в поисковом режиме
позволяет производить синхронизацию с
диском, в синхронизированном используется имитатором
отсутствующих зубьев и логикой
формирования импульсов УОЗ.</p>
<h4>Поисковый режим.</h4>
<p>Программа проверяет предположение, что
текущий зуб является первым. Для чего,
проверяет интервал между двумя последними
зубьями на минимум двукратное превышение
интервала между двумя предпоследними
зубьями. Как только это условие выполнится -
программа переходит в синхронизированный
режим. Если условие не выполняется в
течении продолжительного периода -
возникает состояние "ошибка ДПКВ".</p>
<h4>Работа имитатора отсутствующих зубьев.&nbsp;</h4>
<p>Для возможности привязки событий в
системе управления во всем диапазоне углов
с точностью 6 градусов программа использует имитацию
отсутствующих зубьев номер 59 и 60, таким
образом для менеджмента событий ДПКВ восстанавливается
целостность реперного диска и
обеспечивается полная незаметность
отсутствующих зубьев. При этом программа
естественно предполагает равноускоренное
движение реперного диска на интервале
57-58-59-60 зубьев, поскольку в реальности это
движение может быть и не равноускоренным -
положение прорези специально выбрано таким
образом, чтоб зубья 59 и 60 не попадали в
критическую зону управления двигателем по
углу КВ (например область формирования УОЗ - +60
-10 ПКВ для каждого цилиндра соответственно,
или область детонационного окна).
В системах управления, где положение
прорези может меняться в широких пределах,
зачастую неопытные установщики не
учитывают подобные тонкие моменты, что
может привести к серьезному ухудшению
качества управления двигателем, приводя к
возникновению значительных динамических
ошибок установки УОЗ для одной из пар
цилиндров и др важных переменных. Таким
образом положение прорези не может быть
изменено! Для 4-х (2х) цилиндровых двигателей
в ВМТ должен находится 20 зуб шестерни, для 6-ти(3х)
цилиндровых - 15-й.</p>
<p>В синхронизированном режиме при
обработке события 58 зуба ДПКВ программа предполагает
отсутствие 59-го зуба, поэтому она
переключает 3-й канал модуля capture-compare из
режима захвата в режим сравнения, путем
сброса битов 6 и 7 в регистре CCEN, после чего
микропрограмма берет ранее захваченное
состояние таймера T2 на 58 зубе и добавляет к
нему угловой интервал в тиках Т2 между
зубьями 57 и 58, таким образом предугадывая
момент прохода над датчиком 59 зуба на
основе предположения о равноускоренном
вращении диска в этом угловом интервале.
Полученное значение записывается в ССL3 CCH3,
после чего происходит выполнение событий
привязанных к 58 зубу и передача управления
задачам с низшим приоритетом. Когда
модуль сравнения обнаружит совпадение регистров
таймера T2 и 3-го канала сравнения возникнет
новый флаг события ДПКВ, который будет
обработан как отсутствующий 59 зуб. Точно также будет
установлен момент прохождения
отсутствующего 60-го зуба, обработчик
которого снова переводит 3-й канал модуля
capture-compare в режим захвата, таким образом
имитатор будет отключен и следующий вызов
обработчика будет инициирован аппаратно - 1-м
зубом шестерни.&nbsp;</p>
<h4>Контроль синхронизации.&nbsp;</h4>
<p>В синхронизированном режиме с имитацией
зубьев 59-60 обработчик физически
присутствующих зубьев 1-58 постоянно
проверяет период импульсов с ДПКВ на
признак отсутствующих зубьев (текущий
период импульсов/2&gt;прошлый период
импульсов). Обнаружение такого состояния
выставляет флаг признака ошибки ДПКВ и переводит
программу в поисковый режим. При этом
формирование импульсов зажигания и впрыска
прекращается. Такое состояние является
срывом синхронизации - множественные
признаки ошибки ДПКВ приводят к
фиксированию ошибки ДПКВ для диагностики..&nbsp;</p>
<h4>Опрос датчика фазы.</h4>
<p>Производится в момент прохождения 1-го
зуба реперного диска 60-2 напротив ДПКВ. При
этом положение прорези датчика определяет
конец фазы впуска для 1 цилиндра (посадка на
седло впускных клапанов 1 цилиндра). Если
уровень сигнала на пине&nbsp; входного порта
ДФ P1.2 не изменился&nbsp; после двух идущий подряд опросов -
возникает состояние "ошибка ДФ".&nbsp;</p>
<h4>Формирование импульсов зажигания.&nbsp;</h4>
<p>Угол опережения зажигания представляет
собой знаковое число с разрядностью 8 бит и
шагом 0.5 угловых градуса, что позволяет
реализовать УОЗ в диапазоне от +72 до -56
угловых градуса. Для точного формирования
импульса зажигания в главном цикле
вычислений микропрограмма для каждого
цилиндра производит индивидуальный расчет
4-х параметров:</p>
<p>1) Момент зажигания по номеру зуба ДПКВ (привязка
по углу с точностью 6 градусов)</p>
<p>2) Задержка момента зажигания по углу,
выраженная как коэффициент имеющий
значение 1.00 при 6 градусах (привязка по углу с
точностью 0.5 град)</p>
<p>3) Момент начала накопления энергии по
номеру зуба ДПКВ.</p>
<p>4) Задержка момента накопления энергии по
углу, выраженная как коэффициент имеющий
значение 1.00 при 6 градусах.</p>
<p>При расчетах, из общего "базового УОЗ" после
всех необходимых преобразований для
каждого цилиндра вычитается смещение по
детонации, и индивидуальная цилиндровая
коррекция заданная в калибровках, результат делится на 6 (интервал
зубьев по углу) и трансформируется с учетом
нахождения 20 зуба диска в ВМТ 1 цилиндра.
Остаток от операции деления умножается на 6
(выделяется) и трансформируется
в раскладку задержки момента зажигания от
выбранного зуба.</p>
<p>Время накопления полученное из
калибровки "Время накопления зажигания"
трансформируется в угловые градусы, путем
перемножения на обороты двигателя и
связывающий коэффициент&nbsp; и
ограничивается сверху значением 174 град а
снизу 12 град, чтобы не допустить перекрытие
импульса и пропуск формирования УОЗ. Момент
начала накопления определяется путем
вычитания из расчетного углового момента
зажигания полученного углового времени
накопления.</p>
<p>Алгоритм установки зажигания находится в
обработчике ДПКВ.</p>
<p>Подготовка данных для очередного
цилиндра зажигания производится
одновременно с запуском обработчика
детонации предыдущего связанного с ним
общим каналом зажигания,&nbsp;в точке 66
градусов до ВМТ. При этом микропрограмма
используя переменную номера цилиндра
двигателя в котором только что, прошел рабочий ход, определяет, какой цилиндр
из пары с ним будет
следующим, например: если рабочий ход был в 4-м
- следующим
будет первый, если первый то 4-й. Определив
номер следующего парного цилиндра, микропрограмма
перебрасывает 4 рассчитанных связанных с
ним переменных УОЗ в
рабочие ячейки управления
соответствующего канала зажигания.
Управление каналами зажигания на выходах P5.1 P5.2 после этого
производится полностью раздельно и
автономно.</p>
<p>Для формирования сигнала начала
накопления энергии в катушке зажигания
диспетчер прерывания ДПКВ проверяет
совпадение текущего номера зуба шестерни
60-2 с
"Моментом начала накопления по зубу",
если обнаружено соответствие - программа
производит вычисление времени задержки:</p>
<p>Коэффициент задержки момента накопления энергии по
углу перемножается на переменную "время 6-ти градусного
поворота коленчатого вала" и добавляется к
состоянию Т2 захваченному на входе в
обработчик ДПКВ (прочитанного из регистров
CCL3 CCH3) полученный результат используется
для программирования модуля сравнения и
сброса (compare and clear), и записываются в
регистры COMCLRH COMCLRL. В зависимости от
выбранного канала зажигания в регистр CLRMSK
помещается значение 02h (P5.1) или 04h (P5.2). На
этом функции диспетчера прекращаются и
дальнейшее управление зажиганием
производится аппаратно с использованием
COMCLR модуля.</p>
<p>При совпадении значений в таймере T2 и
регистрах COMCLR, которое произойдет через
заданное время задержки, микроконтроллер переводит
выбранную линию порта P5 в состояние
логического нуля. Драйвер зажигания&nbsp; TPS2814
производит инверсию этого сигнала и
усиление по току, таким образом на
соответствующем выходе
ЭБУ появляется управляющее напряжение +5v.
Если в системе имеется модуль зажигания
General Motors - сигнал непосредственно подается
на его выходные ключи, что приводит к
подключению соответствующей катушки
зажигания в режим накопления энергии.&nbsp;&nbsp;&nbsp;</p>
<p>Установка момента зажигания начинается
при совпадении текущего зуба шестерни с "Моментом
зажигания по номеру зуба", также как
описано ранее производится вычисление времени задержки:
Коэффициент задержки момента зажигания по углу
перемножается на время 6-ти градусного
поворота коленчатого вала и добавляется к
состоянию Т2 захваченному на входе в
обработчик ДПКВ (прочитанного из регистров
CCL3 CCH3) полученный результат используется
для программирования модуля сравнения и
установки (compare and set), и записываются в
регистры COMSETH COMSETL. В зависимости от
выбранного канала зажигания в регистр SETMSK
помещается значение 02h (P5.1) или 04h (P5.2). На
этом функции диспетчера прекращаются и
дальнейшее управление производится
аппаратно с использованием COMSET модуля.</p>
<p>При совпадении значений в таймере T2 и
регистрах COMSET микроконтроллер переводит
выбранную линию порта P5 в состояние
логической 1. Драйвер зажигания TPS2814
производит инверсию этого сигнала и
усиление по току, таким образом на выходе
ЭБУ оказывается низкий потенциал, который
информирует модуль зажигания о
необходимости разорвать цепь подачи тока
на катушку. Магнитное поле, пересекая витки
катушки индуцирует во вторичной обмотке
высокое напряжение, пробивающее зазор в
свече, возникает искра.</p>
<p>В 6-ти цилиндровых прошивках ЭБУ
используется так же третий канал (P5.3)
зажигания. Принцип управления от этого не
меняется.</p>
<p>Подобная методика формирования импульса
зажигания позволяет достичь абсолютную
вычислительную точность по углу и 6мкс по
времени задержки, что в сумме на 10000
оборотах двигателя дает
максимальную погрешность установки УОЗ +-0.3
угловых градуса если диск 60-2 установлен в
нулях.&nbsp; Однако возможно увеличение этой
цифры за счет постоянной времени работы
интегрирующих звеньев как самого канала
формирования сигнала ДПКВ так и
исполнительных устройств зажигания.
Поэтому в ЭБУ предусмотрена компенсация
динамической ошибки связанной с
увеличением оборотов. Для компенсации&nbsp; в
программе имеется поправочный коэффициент
определяемый опытным путем на реальном
наборе датчиков и исполнительных
механизмов и устраняющий рассогласование
прохождения сигнала, коэффициент
представляет собой поправку по углу,
заданную для оборотов 10240 и уменьшающуюся
пропорционально уменьшению оборотов (реальное
значение 2.5 град). Таким образом достигается
финальная точность УОЗ не хуже 0.5 угловых
градуса во всех режимах работы ЭСУД для
любых поддерживаемых оборотов двигателя.
Подобная точность на высоких оборотах в
настоящее время не доступна на многих
aftermarket системах, в которых используются
программные методики менеджмента в ос
реального времени, где динамические ошибки
на высоких оборотах могут быть достаточно велики.</p>
<h4>Работа мягкой отсечки.&nbsp;</h4>
<p>Мягкая отсечка позволяет реализовать
более точное управление двигателем на
предельных оборотах, и подразумевает не
только управление подачей топлива но и
управление зажиганием. Микропрограмма
вычисляет разницу между текущими оборотами
и порогом оборотов отсечки и производит
вырезание зажигания если эта разница менее
200rpm, разница оборотов определяет сколько
импульсов зажигания необходимо пропускать.
Если разницы между оборотами нет -
отключается топливо и зажигание. Если
разница 40 rpm - отключаются каждый 2-й импульс
зажигания (2 цилиндра), 80rpm - каждый 3-й итд.
Пропуск импульса зажигания осуществляется
путем обхода процедуры начала накопления
энергии в катушке зажигания по флагу
взведенному диспетчером мягкой отсечки.</p>
<p><b>Расчеты топлива.</b> </p>
<p>Расчет новой порции топлива инициируется
задачей обработчика сигнала ДПКВ и
начинается сразу же после его завершения в
случае отсутствия задач с более высоким
приоритетом. Топливо рассчитывается один
раз за каждый такт для каждого цилиндра
индивидуально c прохождением всей схемы
расчетов.&nbsp; Микропрограмма вычисляет
обороты двигателя и используя таблицы
квантования - получает точки квантования
для выборки таблиц. после этого расчет
может пойти различными путями, рассмотрим
наиболее популярный метод - вычисление GBC с
использованием ДАД: </p>
<p><b>Вычисление расхода воздуха с
использованием ДАД.</b> </p>
<p>На первом этапе производится чтение
накопительного фильтра АЦП ДАД и расчет
среднего арифметического для всей выборки
данных о давлении. Используя "смещение"
и "наклон характеристики" ДАД
программа пересчитывает среднее
напряжение выборки в абсолютное давление. В
случае фиксации ошибки ДАД используется
виртуальное давление выбираемое из таблицы
по оборотам и положению дросселя.&nbsp; </p>
<p>Вычислив давление производят расчет GBC
фактора - путем перемножения давления с "цилиндровым
объемом двигателя",&nbsp; поправками по
температуре ОЖ и воздуха (в случае не
использования "температуры заряда")
или на фактор температуры заряда. Далее
производится выборка значения
волюметрической эффективности (VE) заданной
в таблицах. Таблиц VE несколько, в частности
они отличаются размерностью. 32x16 или 16x16,
положением фазовращателя. факторами осей
нагрузки (обороты или давление). и др... Полученное
VE перемножают на ранее рассчитанный GBC фактор и фильтруют методом
скользящее среднее с коэффициентами
определяемыми режимом работы двигателя.
Результатом является "Цикловый Расход
Воздуха" (GBC). Массовый расход воздуха
получают делением его значения на время
поворота коленчатого вала на 180 градусов - время
1 цикла (120 для 6-ти цилиндрового ДВС). </p>
<p><b>Базовая топливоподача.</b> </p>
<p>Для вычисления времени впрыска, ранее рассчитанный
цикловой расход воздуха делят на целевой
состав смеси&nbsp; (target AFR) получая таим
образом первичную цикловую подачу топлива.
Общая подача топлива (GTC) включает в себя так
же аддитивные поправки от ускорительных
насосов GTCDR GTCPR и поправку системы downshift assist (топливо
подающееся для раскрутки двигателя перед
включением передачи), мультипликативную
поправку от системы лямбда-регулирования (если
есть), мультипликативную поправку режима 2 (в
случае использования битопливной схемы с
дискретным переключением).
Мультипликативную поправку для коррекции
подачи топлива в безсливной магистрали в
зависимости от давления в ресивере (если на
машине есть такая магистраль).&nbsp; Так же
может быть задействован так называемый
фактор стехиометрии топлива, это значение
представляет собой разницу в стехиометрии
фактического топлива в двигателе и
стехиометрии некоторого базового топлива
для которого простроены базовые
характеристики модели (бензин)). Т.е. все
параметры&nbsp; в данной схеме заданы не для
реального топлива а референсного топлива (если
бы оно было обычным бензином).&nbsp; </p>
<p>В случае работы в попарно-параллельном
режиме впрыска полученный GTC делится на два,
так как такой режим предусматривает
одновременную подачу порции топлива двумя
форсунками.&nbsp;&nbsp; </p>
<p>Для перевода GTC в время впрыска
производится перемножение полученного
значения на индивидуально заданные
коэффициенты статической
производительности форсунок к результату
добавляется время&nbsp;lag time (динамическая производительность
форсунок) и финишное значение
ограничивается снизу минимальным временем
впрыска.. </p>
<p>Далее по таблице определяющей паттерн
связи конфигурации системы с
использованием флага режима впрыска и
номера цилиндра в котором идет впрыск
определяется, какие из форсунок должны быть
открыты в данный момент времени.&nbsp;
Используя полученный паттерн программа
открывает заданные форсунки путем перевода
в состояние лог0 выхода соответствующего
связанного с форсункой порта P4 или P1.
Одновременно включается таймер сравнения
для заданного канала и в него
программируется задержка соответствующая
заданному времени впрыска топлива с
дискретом 6мкс, после чего вывод порта P4
переводится в состояние лог1 однако
фактически на выходе микропроцессора это
состояние возникнет только после того, как
пройдет выдержка времени модуля сравнения
т.е. форсунка выключится через строго
заданное время.&nbsp; </p>
<p>Для компенсации смещения начальной фазы
впрыска связанной с расчетами по топливу в
программе предусмотрен механизм точно
такой же как ранее описанный для УОЗ. </p>

<p><b>Работа алгоритма детектирования
детонации.&nbsp;</b></p>
<p>Начало работы детектора детонации (окна
обзора) задается в калибровке "фаза
начала измерения детонации", конец - "фаза
окончания измерения детонации".
Калибровки, изначально заданные в градусах
по коленчатому валу транслируются главным
циклом вычислений в раскладку 180-ти
градусного такта двигателя по КВ на 6 градусные
интервалы и к ним добавляется смещение
реперного диска ПКВ (20-й зуб). В обработчике ДПКВ при
совпадении "фазы начала измерения"
взводится бит P1.5,&nbsp; соединенный с
контактом INT/HOLD мс HIP9010, при этом начинается
процесс накопления сигнала на интеграторе
микросхемы.
Накопление продолжается, пока не совпадет
угол поворота коленчатого вала и "фаза
окончания измерения", после чего вывод INT/HOLD
переводится в состояние лог 0 и микросхема
HIP9010 фиксирует состояние интегратора.&nbsp;</p>
<p>Чтение состояния интегратора
подключенного к 7-му
канала АЦП микропроцессора, производится обработчиком ДПКВ,
при повороте коленчатого вала на угол 102
градуса после ВМТ. Таким образом к этому
моменту состояние интегратора (фаза
окончания измерения) должно быть зафиксировано. Из прочитанного значения
вычитается собственный шум интегратора,
которым является значение, прочитанное из канала
детонации при остановленном двигателе (первом
включении зажигания) и
ограниченное сверху порогом 0.5v. Полученное
после вычитания значение является уровнем
сигнала в канале детонации (ADET) на основании
которого и производятся все дальнейшие
вычисления.</p>
<p>Запуск задачи обнаружения детонации
производится обработчиком ДПКВ через 114
градусов после ВМТ (через 12 градусов после
чтения состояния интегратора). Обработчик ДПКВ
передает в задачу номер цилиндра в котором
в данный момент идет "рабочий ход"
двигателя для цилиндровой селекции.</p>
<p><b>Нормализация по времени окна.&nbsp;</b></p>
<p>Поскольку окно оценки сигнала детонации (время
интегрирования) задается угловыми
интервалами, алгоритм должен использовать
механизмы нормализации уровня сигнала в
канале учитывающий изменение
продолжительности окна в зависимости от
оборотов двигателя. Для такой нормализации
используется встроенный в микросхему HIP9010 аттенюатор.&nbsp;</p>
<p>Калибровка "Настройка аттенюатора"
на низких оборотах позволяет уменьшить
общее усиление канала детонации,
практически не влияя на него на высоких,
обеспечивая тем самым необходимый уровень
сигнала во всем диапазоне оборотов. Таким
образом нормализация производится
аппаратно и не требуется высокая точность
для снятия отсчетов АЦП.&nbsp;Соответствие
значений в калибровке коэффициентам
усиления микросхемы можно найти в DataSheet
HIP9010.</p>
<h4>Частотная настройка фильтров.</h4>
<p>В программе предусмотрено изменение
частоты настройки фильтра HIP9010 в
зависимости от оборотов двигателя, для чего
используется калибровка "Частота
настройки фильтра" содержащая
непосредственные численные значения из
таблицы частот (см. DataSheet HIP9010).</p>
<p>Обновление регистров микросхемы HIP9010
производится в каждом цикле обработки
информации о цилиндре двигателя.</p>
<p><b>Адаптация по шуму двигателя.&nbsp;</b></p>
<p>Механизм детектирования детонации
позволяет компенсировать изменение уровня
сигнала с датчика детонации связанного с
моментом его затяжки и собственным шумом
двигателя. Для такой адаптации
используется механизм настройки
постоянной времени интегратора. Система
производит адаптацию по шуму двигателя в
точке, где детонация физически не возможна.
Режимная точка для такой адаптации заданна
в калибровке "зона адаптации по шуму"
обычно 2500 rpm 0% дросселя. При попадании в зону
адаптации система производит фильтрацию ADET
асимметричным фильтром, коэффициент
фильтрации которого задан в калибровках
ЭБУ. Полученное значение собственно
считается уровнем шума (NOISE), оно должно
вписываться в диапазон заданный
калибровками "макс порог шума для
переключения аттенюатора на уменьшение"
и "минимальный порог шума для
переключения аттенюатора на увеличение".
Если уровень шума выходит за указанные
пределы - производится изменение состояния
постоянной времени интегратора микросхемы
HIP9010.&nbsp; Существует всего 3 возможных integrator
time constant - 40,80,160 мкс. Если уровень шума
высокий - система увеличивает постоянную
времени интегратора, таким образом
уменьшая результирующее напряжение на его
выходе, если низкий - наоборот уменьшает
постоянную времени увеличивая напряжение.&nbsp;При
этом уровень шума и значения всех фильтров
автоматически пересчитываются, с учетом
нового значения постоянной времени
интегратора</p>
<p>Обновление состояния аттенюатора,
интегратора и частотной настройки фильтров
HIP9010 производится по окончании каждого
вызова обработчика детонации (1 раз за 180градусов
поворота КВ).</p>
<p><b>Детектирование ошибок низкий и высокий
шум двигателя при адаптации.&nbsp;&nbsp;</b></p>
<p>Если постоянная времени интегратора = 40мкс
система сравнивает&nbsp; уровень шума
двигателя с порогом "низкого уровня шума"
и выставляет соответствующую ошибку, если
NOISE &lt; порога. Если постоянная времени = 160
мкс - проверяет превышение порога "высокого
уровня шума", ошибка выставляется если
NOISE &gt; порога.&nbsp;&nbsp;</p>
<p>Для обнаружения детонации в
микропрограмме реализовано 2 алгоритма -
пороговый и дифференциальный.</p>
<p><b>Пороговый механизм обнаружения
детонации.</b>&nbsp;</p>
<p>Пороговый механизм детектирования
детонации оперирует&nbsp; абсолютным
значением уровня сигнала,
однозначно указывающего на детонацию в
двигателе. Детонация в соответствующем цилиндре
обнаруживается, если выполняется следующее
условие:</p>
<p>ADET &gt; NOISE&nbsp; * "Относительный порог
детонации" * "Коррекцию порога
детонации".</p>
<p>Калибровка "Коррекция порога детонации"
может быть настроена на ПАК Матрица в
автоматическом режиме.&nbsp;</p>
<p><b>Дифференциальный механизм обнаружения
детонации.&nbsp;</b></p>
<p>Дифференциальный алгоритм позволяет
обнаруживать детонационные стуки по
превышению уровня сигнала в цилиндре для данного такта
над средней мощностью сигнала текущего
цилиндра. Средняя мощность рассчитывается
для каждого цилиндра индивидуально путем
фильтрации ADET этого цилиндра на достаточно
длительном интервале. Если уровень сигнала
не превышает 0.5 NOISE - считается, что шум в
цилиндре слишком слабый и&nbsp; детонация
данным методом не обнаруживается. </p>
<p>Детонация обнаруживается, если: ADET &gt;
Средняя мощность сигнала в цилиндре * "Порог
детонации".</p>
<p>Обнаружив детонацию, система взводит
один из четырех флагов (в соответствии с
номером цилиндра) которые в дальнейшем
обрабатываются в главном цикле вычислений.</p>
<h4>Диагностирование ошибки "Обрыв
датчика детонации".</h4>
<p>Производится путем сравнения в главном
цикле вычислений суммы средних мощностей
сигналов во всех цилиндрах деленной на 4 (средней
мощности всех цилиндров) с
калибровкой "Минимальный уровень шума
для диагностики". И установкой флага
ошибки "Обрыв датчика детонации" если
при статистическом анализе, в более чем 50% таких проверок
сумма средних мощностей
окажется ниже заданного порога.</p>
<h4>Обработчик детонации в главном цикле
вычислений (20ms).&nbsp;</h4>
<p>Обработчик проверяет признак нахождения
системы в "Зоне контроля детонации"
если признака нет - контроль не
производится. При появлении признака (первичный
вход в зону контроля с низких нагрузок)
производится обнуление переменных всех
цилиндровых отскоков УОЗ (если таковые были
ранее). Так же проверяется "Температура
включения контроля детонации" - она
должна быть превышена для начала работы
алгоритма обработки.</p>
<p>При активных в системе ошибках ДМРВ, ДАД
или ДПДЗ детонация не обрабатывается - смещение
УОЗ не производится.</p>
<p>В случае обнаружения любой из трех ошибок
датчика детонации обработчик
устанавливает постоянное смещение УОЗ в
соответствии с калибровкой "Максимальное
смещение УОЗ при детонации".</p>
<p>В нормальном режиме функционирования, единичное
детектирование детонации не приводит к
изменению УОЗ, для исключения возможных
ошибок детектирования, вызванных
механическими ударами по двигателю (например
мелкими камушками) или щелчками связанными
с температурным расширением его
компонентов. Однако каждое детектирование
детонации выставляет флаг "признак обнаружения
детонации" передаваемый на диагностику.
Если же в течении времени указанного в
калибровке "Минимальное время
детектирования детонации" происходит
вторичное детектирование - в
соответствующем цилиндре производится
отброс УОЗ на 2 градуса, и отсчет периода
времени детектирования начинается заново,
таким образом следующее детектирование
детонации в период этого времени так же
приводит к отбросу УОЗ на 2 градуса и так
далее. Калибровка "Максимальное смещение
УОЗ при детонации" ограничивает значение
отскока УОЗ которое может быть достигнуто
алгоритмом.
Все значения рассчитываются индивидуально
для каждого цилиндра.</p>
<p>Возвращение УОЗ к базовым расчетным значениям
происходит с дискретностью шага 0.5 градуса
и интервалом шага заданного в калибровке
"Период восстановления УОЗ" в том случае,
если за этот период не происходило нового
детектирования детонации в
соответствующем цилиндре двигателя.&nbsp;</p>

<p>&nbsp;</p>
<h1>Цикл и средства разработки программного
обеспечения J5LS.&nbsp;</h1>
<p>&nbsp; Цикл разработки ПО J5LS состоит из
нескольких стадий:</p>
<p>1) Запрос на разработку функциональности
от пользователя или от разработчика ПО.</p>
<p>2) Разработка концептуальной модели
функции. Анализ реализуемости.
Формирование требований.&nbsp;</p>
<p>3) Разработка функции: Моделирование.
Симуляция. Кодирование. Анализ.&nbsp;</p>
<p>4) Интеграция функции в ПО J5LS. (в текущую
версию- в новую версию- в новое поколении
версий).</p>
<p>5) Калибровка и тестирование функции на
испытательном стенде с двигателем или
реальном автомобиле.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<h2>Система нумерации версий J5LS.</h2>
<p><img src="%D0%A5%D0%B0%D1%80%D0%B0%D0%BA%D1%82%D0%B5%D1%80%D0%B8%D1%81%D1%82%D0%B8%D0%BA%D0%B8%20%D0%B8%20%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0%20%D0%BA%D0%BE%D0%BD%D1%82%D1%80%D0%BE%D0%BB%D0%BB%D0%B5%D1%80%D0%BE%D0%B2%20%D1%83%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F%20%D0%B2%D0%BF%D1%80%D1%8B%D1%81%D0%BA%D0%BE%D0%BC%20%D1%82%D0%BE%D0%BF%D0%BB%D0%B8%D0%B2%D0%B0%20%D0%AF%D0%BD%D0%B2%D0%B0%D1%80%D1%8C-5.1%20%D0%AF%D0%BD%D0%B2%D0%B0%D1%80%D1%8C-7.2%20%D0%B8%20%D0%9C%D0%B8%D0%BA%D0%B0%D1%81-7.1%20%D1%81%20%D0%BC%D0%B8%D0%BA%D1%80%D0%BE%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%BE%D0%B9%20J5LS_files/j5lsn.png" <="" p="">
</p><p><b>Позиция 1</b> - Тип электронного блока
управления двигателем:</p>
<p>J5 - Январь-5.1,&nbsp;&nbsp;&nbsp; J7 - Январь-7.2,&nbsp;&nbsp;&nbsp;M7 - Микас-7.1, V5 - VS 5.1 (старая реализация),
M1 - BOSCH M1.5.4</p>
<p><b>Позиция 2 </b>- идентификатор программного
обеспечения LS-LightSport.</p>
<p><b>Позиция 3</b> -&nbsp; идентификатор имплант-мультиплекс
стратегии а так же специальных версий.</p>
<p>_ - базовая версия.&nbsp;</p>
<p>D - Специальная версия ПО ЭБУ Январь-5.1 для
фазированого управления 2мя рядами
топливных форсунок в 4-х цилиндровом
двигателе.</p>
<p>о - Имплант 3-цилиндра на базе ЭБУ Январь-7.2
Ока Евро-3. в замену ЭБУ Bosch M7.9.7+ xiali.</p>
<p>g - Имплант 4-цилиндра на базе ЭБУ Январь-7.2
Hundai Getz и другие в замену ЭБУ Kefiko.</p>
<p>m - Мультиплекс версия. Специальное ПО
предназначенное для создания систем для
управления двигателями 8 или 12 цилиндров на
базе 2-х ЭБУ с использованием шины обмена
информацией между ЭБУ.</p>
<p><b>Позиция 4</b> - идентификатор кодирования
типа двигателя и числа цилиндров.</p>
<p>V - Базовая версия ПО. ВАЗ. Репер 60-2. 20й зуб в
ВМТ 1 цилиндра.</p>
<p>X - Версия для автомобилей Toyota с репером 36-2
(3sgte и аналоги)</p>
<p>Z - Версия для автомобилей VW Volvo Renault и др. -
Репер 60-2 15й зуб в ВМТ 1 цилиндра.</p>
<p>F - Версия для автомобилей Форд - репер
36-1&nbsp;</p>
<p>6&nbsp; - Версия для 3-х или 6-ти цилиндрового
двигателя. Репер 60-2. 15й зуб в ВМТ 1 цилиндра.</p>
<p><b>Позиция 5</b> - Поколение версий. (1-е 2-е 3-е 4-е
5-е)</p>
<p><b>Позиция 6</b> - Номер версии внутри
поколения.</p>
<p>Одинаковой версией программного
обеспечения считается любая версия
совместимая по формату калибровок вниз.
Совместимая по реализованным моделям
основных алгоритмов. Т.е. такое программное
обеспечение которое позволяет работать с
любым из билдов ПО, единой (самой последней)
картой калибровок. А так же производить ее
настройку единым совместимым последним
программным обеспечением. Так же в рамках
единой&nbsp; версии возможно производить
обновление или откат ПО на любую из
подверсий без каких либо ограничений.</p>
<p><b>Позиция 7</b> - Буква подверсии. Подверсии различаются
по реализованной в них функциональности и
целевому применению.&nbsp;</p>
<h3>Структура объекта версии.</h3>
<p>Каждая версия программного обеспечения
J5LS содержит определенный набор файлов
необходимых для сборки ПО. В рамках одной
версии все возможные варианты ПО собираются
из единого файла исходного кода - это
гарантирует единую функциональность и
обеспечивает быстрое исправление ошибок.
Абстракция кода от конкретного аппаратного
обеспечения и жестко запрограммированных
датчиков положения коленчатого вала и фаз
реализована на уровне условной трансляции,
определений, и макрокоманд ассемблера.</p>
<p>Основные файлы объекта версии:</p>
<p>J5LS_V??.a51 - Исходные тексты проекта - базовое
ПО.</p>
<p>??_hal.inc - файлы hadware abstraction level описывающие
реализацию различных алгоритмов драйверов
зависящую от схемотехники конкретного ЭБУ (по одному на каждый
поддерживаемый ЭБУ M7,J7,J5,V5,M1).</p>
<p>*_eal.inc - файлы engine abstraction level содержат
коэффициенты описывающие тип число зубьев
и совместное положение
датчиков ПКВ и ФАЗ на поддерживаемых
двигателях и указание на тип ЭБУ для
которого должна быть собранна прошивка. (по одному на
каждую сборку двигатель + ЭБУ).</p>
<p>*.bat - пакетные файлы запуска сборки (по одному на
каждый вариант прошивки + один общий для
сборки всех вариантов одновременно).</p>
<p>J5LS_V??.ini - файлы описывающие формат карт
калибровок.</p>
<p>J5LS_V??.BAT - пакетный файл сборки карт
калибровок.</p>
<p><img src="%D0%A5%D0%B0%D1%80%D0%B0%D0%BA%D1%82%D0%B5%D1%80%D0%B8%D1%81%D1%82%D0%B8%D0%BA%D0%B8%20%D0%B8%20%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0%20%D0%BA%D0%BE%D0%BD%D1%82%D1%80%D0%BE%D0%BB%D0%BB%D0%B5%D1%80%D0%BE%D0%B2%20%D1%83%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F%20%D0%B2%D0%BF%D1%80%D1%8B%D1%81%D0%BA%D0%BE%D0%BC%20%D1%82%D0%BE%D0%BF%D0%BB%D0%B8%D0%B2%D0%B0%20%D0%AF%D0%BD%D0%B2%D0%B0%D1%80%D1%8C-5.1%20%D0%AF%D0%BD%D0%B2%D0%B0%D1%80%D1%8C-7.2%20%D0%B8%20%D0%9C%D0%B8%D0%BA%D0%B0%D1%81-7.1%20%D1%81%20%D0%BC%D0%B8%D0%BA%D1%80%D0%BE%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%BE%D0%B9%20J5LS_files/j5lsn2.png" <="" p="" width="1162" height="520">

</p><h3>ПО для разработки прошивки.</h3>
<p>Для работы с текстовыми файлами проектов
в качестве редактора используется файловый
менеджер <a href="http://www.dorlov.no-ip.com/connect/" target="_blank"> Connect</a>
by Dmitry
Orlov&nbsp;</p><p>Сборка производится
пакетом от A.D. Software выпущенным для ОС MS-DOS в
1985 году.</p><p>&nbsp;</p><p>&nbsp;




</p></body></html>